# Test Dockerfile for musl-based Linux (Alpine)
ARG DOTNET_VERSION=10.0
FROM mcr.microsoft.com/dotnet/sdk:${DOTNET_VERSION}-alpine

ARG DOTNET_VERSION
ENV FRAMEWORK=net${DOTNET_VERSION}

WORKDIR /app

# Copy the NuGet package
COPY nupkg/ ./nupkg/

# Copy project files
COPY src/ ./src/
COPY tests/ ./tests/
COPY global.json ./global.json

# Remove project reference and add NuGet package reference
RUN dotnet remove tests/SvgToDxf.Tests/SvgToDxf.Tests.csproj reference src/SvgToDxf/SvgToDxf.csproj
RUN dotnet nuget add source /app/nupkg --name local

RUN dotnet add tests/SvgToDxf.Tests/SvgToDxf.Tests.csproj package SvgToDxf --source local --no-restore
RUN dotnet restore tests/SvgToDxf.Tests/SvgToDxf.Tests.csproj -p:TargetFramework=$FRAMEWORK

# Build and run tests
RUN dotnet build tests/SvgToDxf.Tests/SvgToDxf.Tests.csproj --configuration Release --no-restore -p:TargetFramework=$FRAMEWORK
RUN dotnet test --project tests/SvgToDxf.Tests/SvgToDxf.Tests.csproj --configuration Release --no-restore --no-build -p:TargetFramework=$FRAMEWORK
