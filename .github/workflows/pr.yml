name: PR Build and Test

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  build:
    name: Build Sln
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            8.0.x
            9.0.x
            10.0.x

      - name: Restore
        run: dotnet restore

      - name: Build
        run: dotnet build --no-restore --configuration Release

  build-native-linux:
    name: Build Native - Linux ${{ matrix.libc }} ${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            platform: linux/amd64
            libc: glibc
            dockerfile: Dockerfile.glibc
            rid: linux-x64
            runner: ubuntu-latest
          - arch: arm64
            platform: linux/arm64
            libc: glibc
            dockerfile: Dockerfile.glibc
            rid: linux-arm64
            runner: ubuntu-24.04-arm
          - arch: x64
            platform: linux/amd64
            libc: musl
            dockerfile: Dockerfile.musl
            rid: linux-musl-x64
            runner: ubuntu-latest
          - arch: arm64
            platform: linux/arm64
            libc: musl
            dockerfile: Dockerfile.musl
            rid: linux-musl-arm64
            runner: ubuntu-24.04-arm

    steps:
      - uses: actions/checkout@v4

      - name: Get version from csproj
        id: version
        run: |
          VERSION=$(grep -oP '(?<=<Version>)[^<]+' src/SvgToDxf/SvgToDxf.csproj)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build native binary
        run: |
          mkdir -p output
          docker build \
            --platform ${{ matrix.platform }} \
            --build-arg VERSION=${{ steps.version.outputs.version }} \
            -f ${{ matrix.dockerfile }} \
            -o output \
            .

      - name: Rename and verify binary
        run: |
          ls -la output/
          if [ -f "output/dxf_outlines-${{ matrix.rid }}" ]; then
            echo "Binary found: dxf_outlines-${{ matrix.rid }}"
          else
            echo "Expected binary not found!"
            exit 1
          fi

      - name: Upload native binary
        uses: actions/upload-artifact@v4
        with:
          name: native-${{ matrix.rid }}
          path: output/dxf_outlines-${{ matrix.rid }}

  build-native-macos:
    name: Build Native - macOS ${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            nuitka-arch: x86_64
            rid: osx-x64
            runner: macos-latest
          - arch: arm64
            nuitka-arch: arm64
            rid: osx-arm64
            runner: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install nuitka ordered-set lxml numpy tinycss2 cssselect pyparsing

      - name: Get version from csproj
        id: version
        run: |
          VERSION=$(grep -oP '(?<=<Version>)[^<]+' src/SvgToDxf/SvgToDxf.csproj || grep -oE '<Version>[^<]+' src/SvgToDxf/SvgToDxf.csproj | sed 's/<Version>//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Clone Inkscape extensions
        run: |
          git clone https://gitlab.com/inkscape/extensions.git /tmp/inkscape-extensions
          cd /tmp/inkscape-extensions
          git checkout 5e199c99880caa43412b53164a8ccb6baebe6c99

      - name: Build native binary
        run: |
          cd /tmp/inkscape-extensions
          PYTHONPATH=/tmp/inkscape-extensions python -m nuitka \
            --onefile \
            --onefile-tempdir-spec="{TEMP}/dxf_outlines-${{ steps.version.outputs.version }}" \
            --assume-yes-for-downloads \
            --macos-target-arch=${{ matrix.nuitka-arch }} \
            --include-package=inkex \
            --include-data-files=dxf14_header.txt=dxf14_header.txt \
            --include-data-files=dxf14_style.txt=dxf14_style.txt \
            --include-data-files=dxf14_footer.txt=dxf14_footer.txt \
            --output-filename=dxf_outlines-${{ matrix.rid }} \
            dxf_outlines.py

      - name: Verify binary
        run: |
          cd /tmp/inkscape-extensions
          chmod +x dxf_outlines-${{ matrix.rid }}
          file dxf_outlines-${{ matrix.rid }}

      - name: Upload native binary
        uses: actions/upload-artifact@v4
        with:
          name: native-${{ matrix.rid }}
          path: /tmp/inkscape-extensions/dxf_outlines-${{ matrix.rid }}

  package:
    name: Create NuGet Package
    needs: [build, build-native-linux, build-native-macos]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            8.0.x
            9.0.x
            10.0.x

      - name: Download all native binaries
        uses: actions/download-artifact@v4
        with:
          pattern: native-*
          path: natives
          merge-multiple: false

      - name: Setup native binaries for packaging
        run: |
          mkdir -p src/SvgToDxf/runtimes/linux-x64/native
          mkdir -p src/SvgToDxf/runtimes/linux-arm64/native
          mkdir -p src/SvgToDxf/runtimes/linux-musl-x64/native
          mkdir -p src/SvgToDxf/runtimes/linux-musl-arm64/native
          mkdir -p src/SvgToDxf/runtimes/osx-x64/native
          mkdir -p src/SvgToDxf/runtimes/osx-arm64/native
          
          cp natives/native-linux-x64/dxf_outlines-linux-x64 src/SvgToDxf/runtimes/linux-x64/native/
          cp natives/native-linux-arm64/dxf_outlines-linux-arm64 src/SvgToDxf/runtimes/linux-arm64/native/
          cp natives/native-linux-musl-x64/dxf_outlines-linux-musl-x64 src/SvgToDxf/runtimes/linux-musl-x64/native/
          cp natives/native-linux-musl-arm64/dxf_outlines-linux-musl-arm64 src/SvgToDxf/runtimes/linux-musl-arm64/native/
          cp natives/native-osx-x64/dxf_outlines-osx-x64 src/SvgToDxf/runtimes/osx-x64/native/
          cp natives/native-osx-arm64/dxf_outlines-osx-arm64 src/SvgToDxf/runtimes/osx-arm64/native/

      - name: Build and Pack NuGet
        run: |
          dotnet build src/SvgToDxf/SvgToDxf.csproj --configuration Release
          dotnet pack src/SvgToDxf/SvgToDxf.csproj --configuration Release --no-build --output ./nupkg

      - name: Upload NuGet package
        uses: actions/upload-artifact@v4
        with:
          name: nuget-package
          path: ./nupkg/*.nupkg

  test-nuget-linux:
    name: Test NuGet - Linux ${{ matrix.libc }} ${{ matrix.arch }}
    needs: [package]
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            libc: glibc
            runner: ubuntu-latest
            platform: linux/amd64
          - arch: arm64
            libc: glibc
            runner: ubuntu-24.04-arm
            platform: linux/arm64
          - arch: x64
            libc: musl
            runner: ubuntu-latest
            platform: linux/amd64
          - arch: arm64
            libc: musl
            runner: ubuntu-24.04-arm
            platform: linux/arm64

    steps:
      - uses: actions/checkout@v4

      - name: Download NuGet package
        uses: actions/download-artifact@v4
        with:
          name: nuget-package
          path: ./nupkg

      - name: Run tests in Docker (net8.0)
        run: |
          docker build \
            --platform ${{ matrix.platform }} \
            --build-arg DOTNET_VERSION=8.0 \
            -f Dockerfile.test.${{ matrix.libc }} \
            .

      - name: Run tests in Docker (net9.0)
        run: |
          docker build \
            --platform ${{ matrix.platform }} \
            --build-arg DOTNET_VERSION=9.0 \
            -f Dockerfile.test.${{ matrix.libc }} \
            .

      - name: Run tests in Docker (net10.0)
        run: |
          docker build \
            --platform ${{ matrix.platform }} \
            --build-arg DOTNET_VERSION=10.0 \
            -f Dockerfile.test.${{ matrix.libc }} \
            .

  test-nuget-macos:
    name: Test NuGet - macOS ${{ matrix.arch }} ${{ matrix.framework }}
    needs: [package]
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        arch:
          - x64
          - arm64
        dotnet-version:
          - "8.0"
          - "9.0"
          - "10.0"
        include:
          - arch: x64
            runner: macos-15-intel
          - arch: arm64
            runner: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET ${{ matrix.dotnet-version }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ matrix.dotnet-version }}.x

      - name: Download NuGet package
        uses: actions/download-artifact@v4
        with:
          name: nuget-package
          path: ./nupkg

      - name: Replace project reference with NuGet package
        run: |
          cd tests/SvgToDxf.Tests
          dotnet remove reference ../../src/SvgToDxf/SvgToDxf.csproj || true
          dotnet nuget add source $PWD/../../nupkg --name local || true
          dotnet add package SvgToDxf --source local --no-restore
          # Extract version and add to Directory.Packages.props, remove from csproj (CPM pattern)
          VERSION=$(grep -oE 'Include="SvgToDxf" Version="[^"]+' SvgToDxf.Tests.csproj | sed 's/.*Version="//')
          sed -i '' "s|</ItemGroup>|  <PackageVersion Include=\"SvgToDxf\" Version=\"$VERSION\" /></ItemGroup>|" ../../Directory.Packages.props
          sed -i '' 's|<PackageReference Include="SvgToDxf" Version="[^"]*"|<PackageReference Include="SvgToDxf"|' SvgToDxf.Tests.csproj
          dotnet restore -p:TargetFramework=net${{ matrix.dotnet-version }}

      - name: Run tests
        run: dotnet test tests/SvgToDxf.Tests --configuration Release --no-restore -p:TargetFramework=net${{ matrix.dotnet-version }}

  release:
    name: Create GitHub Release
    needs: [test-nuget-linux, test-nuget-macos]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Get version from csproj
        id: version
        run: |
          VERSION=$(grep -oP '(?<=<Version>)[^<]+' src/SvgToDxf/SvgToDxf.csproj)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Check if tag already exists
        run: |
          if git ls-remote --tags origin | grep -q "refs/tags/v${{ steps.version.outputs.version }}$"; then
            echo "::error::Tag v${{ steps.version.outputs.version }} already exists. Please update the version in src/SvgToDxf/SvgToDxf.csproj"
            exit 1
          fi
          echo "Tag v${{ steps.version.outputs.version }} does not exist, proceeding with release"

      - name: Download NuGet package
        uses: actions/download-artifact@v4
        with:
          name: nuget-package
          path: ./nupkg

      - name: Download native binaries
        uses: actions/download-artifact@v4
        with:
          pattern: native-*
          path: ./natives
          merge-multiple: false

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: v${{ steps.version.outputs.version }}
          generate_release_notes: true
          files: |
            ./nupkg/*.nupkg
            ./natives/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  push:
    name: Push NuGet Package
    needs: [release]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Download NuGet package
        uses: actions/download-artifact@v4
        with:
          name: nuget-package
          path: ./nupkg

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Push to NuGet.org
        run: |
          dotnet nuget push ./nupkg/*.nupkg \
            --api-key ${{ secrets.NUGET_API_KEY }} \
            --source https://api.nuget.org/v3/index.json \
            --skip-duplicate
