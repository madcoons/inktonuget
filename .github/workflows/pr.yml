name: PR Build and Test

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            8.0.x
            9.0.x
            10.0.x

      - name: Restore
        run: dotnet restore

      - name: Build
        run: dotnet build --no-restore --configuration Release

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: |
            src/SvgToDxf/bin/Release/
            tests/SvgToDxf.Tests/bin/Release/

  build-native-linux:
    name: Build Native - Linux ${{ matrix.libc }} ${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            platform: linux/amd64
            libc: glibc
            dockerfile: Dockerfile.glibc
            rid: linux-x64
            runner: ubuntu-latest
          - arch: arm64
            platform: linux/arm64
            libc: glibc
            dockerfile: Dockerfile.glibc
            rid: linux-arm64
            runner: macos-latest
          - arch: x64
            platform: linux/amd64
            libc: musl
            dockerfile: Dockerfile.musl
            rid: linux-musl-x64
            runner: ubuntu-latest
          - arch: arm64
            platform: linux/arm64
            libc: musl
            dockerfile: Dockerfile.musl
            rid: linux-musl-arm64
            runner: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build native binary
        run: |
          mkdir -p output
          docker build \
            --platform ${{ matrix.platform }} \
            -f ${{ matrix.dockerfile }} \
            -o output \
            .

      - name: Rename and verify binary
        run: |
          ls -la output/
          if [ -f "output/dxf_outlines-${{ matrix.rid }}" ]; then
            echo "Binary found: dxf_outlines-${{ matrix.rid }}"
          else
            echo "Expected binary not found!"
            exit 1
          fi

      - name: Upload native binary
        uses: actions/upload-artifact@v4
        with:
          name: native-${{ matrix.rid }}
          path: output/dxf_outlines-${{ matrix.rid }}

  build-native-macos:
    name: Build Native - macOS universal
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install nuitka ordered-set lxml numpy tinycss2 cssselect pyparsing

      - name: Clone Inkscape extensions
        run: |
          git clone https://gitlab.com/inkscape/extensions.git /tmp/inkscape-extensions
          cd /tmp/inkscape-extensions
          git checkout 5e199c99880caa43412b53164a8ccb6baebe6c99

      - name: Build with Nuitka (universal binary)
        run: |
          cd /tmp/inkscape-extensions
          PYTHONPATH=/tmp/inkscape-extensions python -m nuitka \
            --onefile \
            --assume-yes-for-downloads \
            --macos-target-arch=universal \
            --include-package=inkex \
            --include-data-files=dxf14_header.txt=dxf14_header.txt \
            --include-data-files=dxf14_style.txt=dxf14_style.txt \
            --include-data-files=dxf14_footer.txt=dxf14_footer.txt \
            dxf_outlines.py

      - name: Rename binary
        run: |
          mv /tmp/inkscape-extensions/dxf_outlines.bin /tmp/inkscape-extensions/dxf_outlines-osx
          chmod +x /tmp/inkscape-extensions/dxf_outlines-osx
          # Verify it's a universal binary
          file /tmp/inkscape-extensions/dxf_outlines-osx
          lipo -info /tmp/inkscape-extensions/dxf_outlines-osx

      - name: Upload native binary
        uses: actions/upload-artifact@v4
        with:
          name: native-osx
          path: /tmp/inkscape-extensions/dxf_outlines-osx

  package:
    name: Create NuGet Package
    needs: [build, build-native-linux, build-native-macos]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Download all native binaries
        uses: actions/download-artifact@v4
        with:
          pattern: native-*
          path: natives
          merge-multiple: false

      - name: Setup native binaries for packaging
        run: |
          mkdir -p src/SvgToDxf/runtimes/linux-x64/native
          mkdir -p src/SvgToDxf/runtimes/linux-arm64/native
          mkdir -p src/SvgToDxf/runtimes/linux-musl-x64/native
          mkdir -p src/SvgToDxf/runtimes/linux-musl-arm64/native
          mkdir -p src/SvgToDxf/runtimes/osx/native
          
          cp natives/native-linux-x64/dxf_outlines-linux-x64 src/SvgToDxf/runtimes/linux-x64/native/
          cp natives/native-linux-arm64/dxf_outlines-linux-arm64 src/SvgToDxf/runtimes/linux-arm64/native/
          cp natives/native-linux-musl-x64/dxf_outlines-linux-musl-x64 src/SvgToDxf/runtimes/linux-musl-x64/native/
          cp natives/native-linux-musl-arm64/dxf_outlines-linux-musl-arm64 src/SvgToDxf/runtimes/linux-musl-arm64/native/
          cp natives/native-osx/dxf_outlines-osx src/SvgToDxf/runtimes/osx/native/

      - name: Pack NuGet
        run: dotnet pack src/SvgToDxf/SvgToDxf.csproj --configuration Release --output ./nupkg

      - name: Upload NuGet package
        uses: actions/upload-artifact@v4
        with:
          name: nuget-package
          path: ./nupkg/*.nupkg

  test-nuget:
    name: Test NuGet Package - ${{ matrix.os }}
    needs: [package]
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux
            runner: ubuntu-latest
          - os: macos
            runner: macos-latest

    steps:
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Download NuGet package
        uses: actions/download-artifact@v4
        with:
          name: nuget-package
          path: ./nupkg

      - name: Create test project
        run: |
          dotnet new console -n NuGetTest -o test-project
          cd test-project
          dotnet nuget add source ../nupkg --name local
          dotnet add package SvgToDxf --source local

      - name: Create test code
        run: |
          cat > test-project/Program.cs << 'EOF'
          using SvgToDxf;

          Console.WriteLine("Testing SvgToDxf NuGet package...");

          var svg = """
              <?xml version="1.0" encoding="UTF-8"?>
              <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100">
                  <rect x="10" y="10" width="80" height="80" fill="none" stroke="black"/>
              </svg>
              """;

          var svgBytes = System.Text.Encoding.UTF8.GetBytes(svg);

          try
          {
              var converter = new SvgToDxfConverter();
              var dxfBytes = await converter.ConvertAsync(svgBytes);
              
              var dxfContent = System.Text.Encoding.UTF8.GetString(dxfBytes);
              
              if (dxfBytes.Length == 0)
              {
                  Console.WriteLine("ERROR: Empty DXF output");
                  Environment.Exit(1);
              }
              
              if (!dxfContent.Contains("SECTION") || !dxfContent.Contains("ENTITIES"))
              {
                  Console.WriteLine("ERROR: Invalid DXF content");
                  Environment.Exit(1);
              }
              
              Console.WriteLine($"SUCCESS: Generated {dxfBytes.Length} bytes of DXF data");
              Console.WriteLine("DXF preview (first 500 chars):");
              Console.WriteLine(dxfContent.Substring(0, Math.Min(500, dxfContent.Length)));
          }
          catch (Exception ex)
          {
              Console.WriteLine($"ERROR: {ex.Message}");
              Environment.Exit(1);
          }
          EOF

      - name: Run test
        run: |
          cd test-project
          dotnet run

  push:
    name: Push NuGet Package
    needs: [test-nuget]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Download NuGet package
        uses: actions/download-artifact@v4
        with:
          name: nuget-package
          path: ./nupkg

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Push to NuGet.org
        run: |
          dotnet nuget push ./nupkg/*.nupkg \
            --api-key ${{ secrets.NUGET_API_KEY }} \
            --source https://api.nuget.org/v3/index.json \
            --skip-duplicate
