name: PR Build and Test

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  build:
    name: Build Sln
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            8.0.x
            9.0.x
            10.0.x

      - name: Restore
        run: dotnet restore

      - name: Build
        run: dotnet build --no-restore --configuration Release

  build-native-linux:
    name: Build Native - Linux ${{ matrix.libc }} ${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            platform: linux/amd64
            libc: glibc
            dockerfile: Dockerfile.glibc
            rid: linux-x64
            runner: ubuntu-latest
          - arch: arm64
            platform: linux/arm64
            libc: glibc
            dockerfile: Dockerfile.glibc
            rid: linux-arm64
            runner: ubuntu-24.04-arm
          - arch: x64
            platform: linux/amd64
            libc: musl
            dockerfile: Dockerfile.musl
            rid: linux-musl-x64
            runner: ubuntu-latest
          - arch: arm64
            platform: linux/arm64
            libc: musl
            dockerfile: Dockerfile.musl
            rid: linux-musl-arm64
            runner: ubuntu-24.04-arm

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build native binary
        run: |
          mkdir -p output
          docker build \
            --platform ${{ matrix.platform }} \
            -f ${{ matrix.dockerfile }} \
            -o output \
            .

      - name: Rename and verify binary
        run: |
          ls -la output/
          if [ -f "output/dxf_outlines-${{ matrix.rid }}" ]; then
            echo "Binary found: dxf_outlines-${{ matrix.rid }}"
          else
            echo "Expected binary not found!"
            exit 1
          fi

      - name: Upload native binary
        uses: actions/upload-artifact@v4
        with:
          name: native-${{ matrix.rid }}
          path: output/dxf_outlines-${{ matrix.rid }}

  build-native-macos:
    name: Build Native - macOS ${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            nuitka-arch: x86_64
            rid: osx-x64
            runner: macos-latest
          - arch: arm64
            nuitka-arch: arm64
            rid: osx-arm64
            runner: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install nuitka ordered-set lxml numpy tinycss2 cssselect pyparsing

      - name: Clone Inkscape extensions
        run: |
          git clone https://gitlab.com/inkscape/extensions.git /tmp/inkscape-extensions
          cd /tmp/inkscape-extensions
          git checkout 5e199c99880caa43412b53164a8ccb6baebe6c99

      - name: Build native binary
        run: |
          cd /tmp/inkscape-extensions
          PYTHONPATH=/tmp/inkscape-extensions python -m nuitka \
            --onefile \
            --assume-yes-for-downloads \
            --macos-target-arch=${{ matrix.nuitka-arch }} \
            --include-package=inkex \
            --include-data-files=dxf14_header.txt=dxf14_header.txt \
            --include-data-files=dxf14_style.txt=dxf14_style.txt \
            --include-data-files=dxf14_footer.txt=dxf14_footer.txt \
            --output-filename=dxf_outlines-${{ matrix.rid }} \
            dxf_outlines.py

      - name: Verify binary
        run: |
          cd /tmp/inkscape-extensions
          chmod +x dxf_outlines-${{ matrix.rid }}
          file dxf_outlines-${{ matrix.rid }}

      - name: Upload native binary
        uses: actions/upload-artifact@v4
        with:
          name: native-${{ matrix.rid }}
          path: /tmp/inkscape-extensions/dxf_outlines-${{ matrix.rid }}

  package:
    name: Create NuGet Package
    needs: [build, build-native-linux, build-native-macos]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Download all native binaries
        uses: actions/download-artifact@v4
        with:
          pattern: native-*
          path: natives
          merge-multiple: false

      - name: Setup native binaries for packaging
        run: |
          mkdir -p src/SvgToDxf/runtimes/linux-x64/native
          mkdir -p src/SvgToDxf/runtimes/linux-arm64/native
          mkdir -p src/SvgToDxf/runtimes/linux-musl-x64/native
          mkdir -p src/SvgToDxf/runtimes/linux-musl-arm64/native
          mkdir -p src/SvgToDxf/runtimes/osx-x64/native
          mkdir -p src/SvgToDxf/runtimes/osx-arm64/native
          
          cp natives/native-linux-x64/dxf_outlines-linux-x64 src/SvgToDxf/runtimes/linux-x64/native/
          cp natives/native-linux-arm64/dxf_outlines-linux-arm64 src/SvgToDxf/runtimes/linux-arm64/native/
          cp natives/native-linux-musl-x64/dxf_outlines-linux-musl-x64 src/SvgToDxf/runtimes/linux-musl-x64/native/
          cp natives/native-linux-musl-arm64/dxf_outlines-linux-musl-arm64 src/SvgToDxf/runtimes/linux-musl-arm64/native/
          cp natives/native-osx-x64/dxf_outlines-osx-x64 src/SvgToDxf/runtimes/osx-x64/native/
          cp natives/native-osx-arm64/dxf_outlines-osx-arm64 src/SvgToDxf/runtimes/osx-arm64/native/

      - name: Pack NuGet
        run: dotnet pack src/SvgToDxf/SvgToDxf.csproj --configuration Release --output ./nupkg

      - name: Upload NuGet package
        uses: actions/upload-artifact@v4
        with:
          name: nuget-package
          path: ./nupkg/*.nupkg

  test-nuget-linux:
    name: Test NuGet - Linux ${{ matrix.libc }} ${{ matrix.arch }}
    needs: [package]
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            libc: glibc
            runner: ubuntu-latest
            platform: linux/amd64
          - arch: arm64
            libc: glibc
            runner: ubuntu-24.04-arm
            platform: linux/arm64
          - arch: x64
            libc: musl
            runner: ubuntu-latest
            platform: linux/amd64
          - arch: arm64
            libc: musl
            runner: ubuntu-24.04-arm
            platform: linux/arm64

    steps:
      - uses: actions/checkout@v4

      - name: Download NuGet package
        uses: actions/download-artifact@v4
        with:
          name: nuget-package
          path: ./nupkg

      - name: Run tests in Docker (net8.0)
        run: |
          docker build \
            --platform ${{ matrix.platform }} \
            --build-arg DOTNET_VERSION=8.0 \
            -f Dockerfile.test.${{ matrix.libc }} \
            .

      - name: Run tests in Docker (net9.0)
        run: |
          docker build \
            --platform ${{ matrix.platform }} \
            --build-arg DOTNET_VERSION=9.0 \
            -f Dockerfile.test.${{ matrix.libc }} \
            .

      - name: Run tests in Docker (net10.0)
        run: |
          docker build \
            --platform ${{ matrix.platform }} \
            --build-arg DOTNET_VERSION=10.0 \
            -f Dockerfile.test.${{ matrix.libc }} \
            .

  test-nuget-macos:
    name: Test NuGet - macOS ${{ matrix.arch }}
    needs: [package]
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            rid: osx-x64
            runner: macos-15-intel
          - arch: arm64
            rid: osx-arm64
            runner: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            8.0.x
            9.0.x
            10.0.x

      - name: Download NuGet package
        uses: actions/download-artifact@v4
        with:
          name: nuget-package
          path: ./nupkg

      - name: Replace project reference with NuGet package
        run: |
          # Remove project reference and add package reference
          cd tests/SvgToDxf.Tests
          dotnet remove reference ../../src/SvgToDxf/SvgToDxf.csproj
          dotnet nuget add source $PWD/../../nupkg --name local
          dotnet add package SvgToDxf --source local

      - name: Run tests (net8.0)
        run: dotnet test tests/SvgToDxf.Tests --configuration Release --framework net8.0

      - name: Run tests (net9.0)
        run: dotnet test tests/SvgToDxf.Tests --configuration Release --framework net9.0

      - name: Run tests (net10.0)
        run: dotnet test tests/SvgToDxf.Tests --configuration Release --framework net10.0

  push:
    name: Push NuGet Package
    needs: [test-nuget-linux, test-nuget-macos]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Download NuGet package
        uses: actions/download-artifact@v4
        with:
          name: nuget-package
          path: ./nupkg

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Push to NuGet.org
        run: |
          dotnet nuget push ./nupkg/*.nupkg \
            --api-key ${{ secrets.NUGET_API_KEY }} \
            --source https://api.nuget.org/v3/index.json \
            --skip-duplicate
